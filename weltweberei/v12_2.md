# üåê Weltgewebe v12.2 ‚Äî Maximal Detaillierte Komplettversion (mit Login & Optimierungen)

## 0) Leitplanken & Prinzipien (unverhandelbar)

**Philosophische Grundlagen (v11.1 + zukunftsmusik.md):**
- **Alles ist Event**: Append-only, unver√§nderlich; Hash-Kette pro Aggregat (Rolle, Knoten, Antrag, Delegation, Konto)
- **Radikale Transparenz**: Jede Aktion erzeugt Events ‚Äì inkl. Fehler (EventRejected) und Admin-Aktionen (AdminActionExecuted)
- **Fadenpflicht**: Jede **aktive** Nutzeraktion an einem Karten-Knoten erzeugt automatisch einen Faden von dessen Rolle zum Handlungsort (Subtyp je Aktion)
- **Sichtbarkeit ist W√§hrung**: Expliziter Verzicht auf Token/Credits; nur sichtbares Engagement, Ressourcen und Spenden sind "Wert". Passive Betrachtung bleibt unsichtbar
- **Ethik & Autonomie**: Keine Black-Boxes, Peer-Verifikation (2-von-N), Datenschutz by Design, DSGVO-konform
- **Global skalierbar**: Von Nachbarschaft bis weltweites Myzel mit R√ºckrufbarkeit aller Delegierten

**Technische Leitplanken:**
- **Small-Team-Ops**: 1-2 Personen betreibbar, MTTR ‚â§15 min, klare Runbooks, Healthchecks (/health/live, /health/ready)
- **Kostenarm**: Ziel <‚Ç¨0,01/1.000 Events; Echtzeit-Kosten-Metrik im Dashboard
- **JetStream-Kern**: NATS JetStream als unverr√ºckbarer Event-Backbone, Redis nur Fallback & Speed-Layer
- **Community-First**: Phase A liefert vollst√§ndige lokale Weberei-Erfahrung ab Tag 1

**Visualsprache:**
- **Faden** = verg√§nglich (7-Tage Fade), farbkodiert nach Subtyp
- **Garn** = verzwirnte F√§den (permanent, sichtbar verzwirnt), sch√ºtzt Knoten vor Verfall
- **Goldfaden** = nur Spenden (Finanzfluss, goldfarbig)

***

## 1) UX & Informationsarchitektur

### 1.1 Karten-Zentralansicht (MapLibre GL)
**Standardzustand:** Vollbild-Karte ohne aufgeklappte Panels, mobile-first Design.

**Pull-Tabs (ausziehbare Drawer):**
- **Links**: "Webrat & N√§hst√ºbchen" (360px desktop, modal mobile)
  - Gemeinsamer Drawer (Doppelbenennung zeigt Bandbreite von Plaudern bis Governance)
  - Ortsunabh√§ngige Threads, situative Abstimmungen entstehen in Threads
  - Thread-Liste (pinnable, zuletzt aktiv), Rich-Text Editor
- **Rechts**: "Filter & Ebenen" (300px desktop)
  - Toggles: Knotenarten, Zeitfenster (24h/7d/Snapshots), Delegationen, Goldf√§den, Governance-Marker
  - **Fadenarten-Filter**: Erweiterte Toggles f√ºr jeden Subtyp (Gespr√§ch, Gestaltung, Ver√§nderung, Antrag, Abstimmung, Gold, Delegation)
  - Fadenarten-Legende (farbkodiert), H3-Aufl√∂sung adaptiv zu Zoom-Level
- **Oben Mitte**: "Ortsgewebekonto-Visualisierung"
  - Drawer mit Saldo/Bewegungen, ausstehende SEPA/FinTS
  - CSV/JSON-Export, Transparenz-Links
- **Oben rechts**: "Konto-Zugriff" 
  - **Nicht eingeloggt**: Graues Rollen-Icon mit "+" Badge ‚Üí √∂ffnet Login-Drawer
  - **Eingeloggt**: Eigene Garnrolle in Profilfarbe (+ Verifizier-Haken) ‚Üí √∂ffnet Profil-Drawer
  - Peer-Verifikation (2-von-N), Benachrichtigungen, Datenschutz, Feature-Flags

**Nur-Karten-F√§den:** F√§den verbinden Rollen (am Wohnsitz) mit Karten-Knoten; **keine F√§den in/zu Slidern**.

**Interaktive Onboarding-Tour (FF_TOUR=true):**
```svelte
<!-- Tour Component -->
<script>
  import { onMount } from 'svelte';
  import { tourState } from '$lib/stores/tour';
  
  const tourSteps = [
    { target: '[data-testid="karte"]', text: 'Herzlich willkommen! Dies ist deine Weberei-Karte.' },
    { target: '[data-testid="webrat-tab"]', text: 'Im Webrat diskutiert ihr ortsunabh√§ngig.' },
    { target: '[data-testid="filter-tab"]', text: 'Hier filterst du nach Fadenarten und Zeitr√§umen.' },
    { target: '[data-testid="knoten-knuepfen"]', text: 'Kn√ºpfe deinen ersten Knoten ‚Äì er erzeugt automatisch einen Gestaltungsfaden!' },
    { target: '[data-testid="verzwirnen-button"]', text: 'Verzwirnte F√§den werden zu dauerhaftem Garn und sch√ºtzen Knoten.' }
  ];

  onMount(() => {
    if (localStorage.getItem('tourCompleted') === null && $tourState.enabled) {
      startInteractiveTour(tourSteps);
    }
  });
</script>
```

**Interaktion:**
- Subtile Icons (A11y-kontrast), Drag/Click ‚Üí Drawer
- Tastatur: Tab-Navigation, ESC schlie√üt, ARIA-live Updates
- Touch: Swipe-Gesten, Progressive Enhancement

### 1.2 Knotenr√§ume (automatisch)
- **Automatik**: Jeder Knoten erzeugt **automatisch** bei Kn√ºpfung seinen Raum (Info | Threads | Gestalten | Teilnehmende | Historie)
- **√ñffnen**: Tap/Klick auf Knoten ‚Üí Raum-Fenster √∂ffnet sich
- **Threading**: Live-Sync via WebSocket, Offline Outbox (Dexie)
- **Markdown**: Rich-Text, @Erw√§hnungen, Anh√§nge, Verzwirnen-Button

### 1.3 Karte & Faden-Visualisierung
**Fadenarten (sichtbar, farbkodiert; Legende in rechter Drawer-Leiste):**
- **Gespr√§ch** (blau): Beitrag/Kommentar
- **Gestaltung** (gr√ºn): Kn√ºpfen/√úberarbeiten eines Knotens  
- **Ver√§nderung** (orange): Bestehendes √§ndern
- **Antrag** (rot): Antrag stellen/begleiten
- **Abstimmung** (violett): Stimme abgegeben
- **Goldfaden** (gold): Spende/Finanzfluss
- **Delegation** (grau): **Immer sichtbar**, Stimm√ºbertragung transparent

**Alpha-Verfall:** F√§den verblassen linear √ºber 7 Tage (Opacity 1.0 ‚Üí 0.0, aus UI ersichtlich)

**Garn:** Sichtbar verzwirnt (2-3 parallele Str√§nge), dicker, permanent

**Goldf√§den:**
- Zoom-Out: Aggregiert als Heat/Flows
- Zoom-In: Linien Rolle ‚Üí Konto-Knoten/Ziel-Knoten
- Tooltip: Betrag + Status (Initiated/Pending/Settled)
- Statusfarben: initiated (gestrichelt), pending (durchgezogen), settled (glow)

**Delegationsf√§den:** **Immer sichtbar** als graue Pfeile, Tooltip: Stimmgewicht, letzte Aktivit√§t, Ablaufzeit

### 1.4 Reale Verortungen (neue Knoten)
- **Ortsgewebekonto**: Fester Karten-Knoten (Ort je Weberei), Goldf√§den f√ºhren dorthin
- **Webrat & N√§hst√ºbchen**: Eigene Karten-Knoten (symbolisch/praktisch definierter Ort); F√§den f√ºhren dorthin, **nicht in den Drawer**

### 1.5 Login & Authentifizierung
**Login-Drawer (nicht eingeloggt):**
```svelte
<div class="login-drawer">
  <h3>Melde dich an ‚Äì ohne Passwort</h3>
  <p>Am sichersten mit Passkey. Alternativ E-Mail-Link.<br>
     Du bestimmst, was sichtbar ist. Wir tracken nichts.</p>
  
  <button class="passkey-btn" on:click={loginWithPasskey}>
    üîê Mit Passkey anmelden
  </button>
  
  <div class="magic-link">
    <input type="email" placeholder="E-Mail f√ºr Magic-Link" bind:value={email} />
    <button on:click={sendMagicLink}>Link senden</button>
  </div>
  
  {#if FF_OIDC}
    <button class="oidc-btn" on:click={loginWithOIDC}>Mit SSO anmelden</button>
  {/if}
  
  <button class="anonymous-btn" on:click={continueAnonymous}>Weiter ohne Konto</button>
</div>
```

**Mikro-Interaktion "Rollen-Drehung":**
- **Wann**: Sofort nach erfolgreichem Login (Session erstellt)
- **Was**: Eigene Rollen-Marke f√ºhrt 540¬∞-Drehung aus (800ms Desktop, 900ms Mobile)
- **A11y**: Respektiert `prefers-reduced-motion` ‚Üí kurzes Aufgl√ºhen (300ms) statt Rotation

```svelte
<!-- Garnrollen-Marker -->
<div class="roll-marker {$triggerRoleSpin > 0 ? 'spin' : ''}" 
     aria-label="Deine Rolle">
</div>

<style>
.roll-marker {
  width: 28px; height: 28px; border-radius: 50%;
  background: radial-gradient(#c28a3a, #8a5a1a);
  box-shadow: 0 0 0 2px rgba(255,255,255,.8), 0 2px 6px rgba(0,0,0,.25);
  transform-origin: 50% 50%;
}
@media (prefers-reduced-motion: no-preference) {
  .spin { animation: roll-spin .8s cubic-bezier(.2,.8,.2,1) 1; }
  @keyframes roll-spin {
    0% { transform: scale(1.06) rotate(0deg); filter: brightness(1.15); }
    85% { transform: scale(1.00) rotate(540deg); }
    100% { transform: scale(1.00) rotate(540deg); filter: brightness(1.00); }
  }
}
@media (prefers-reduced-motion: reduce) {
  .spin { animation: roll-glow .3s ease-out 1; }
  @keyframes roll-glow { 
    0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, .8); }
    100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
  }
}
</style>
```

### 1.6 Suche, A11y & Offline
**Erweiterte Suche:** Volltextsuche √ºber knoten.title, antraege.title, rollen.name + **Fadenarten-Filter** (z.B. "Nur Gestaltungsf√§den"); bei Treffer Highlighting + entfernungsbasierte durchklickbare Liste.

**A11y Features:**
- ARIA-Live-Regionen f√ºr Karten-Updates mit **dynamischen Labels** f√ºr Fade-Animationen (z.B. "Faden verblasst in 3 Tagen")
- Vollst√§ndige Keyboard-Steuerung der Drawer (Tab, Enter, ESC)
- Mobile Swipe + Tastatur-√Ñquivalente
- Screenreader-Tests (NVDA/VoiceOver)
- Kontrastierte Fadenfarben
- Focus-trap in Drawern

**Erweiterte Offline-Unterst√ºtzung:**
```javascript
// Erweiterte Dexie-Outbox mit Konfliktl√∂sung
db.outbox.hook('creating', (primKey, obj) => {
  obj.conflictResolution = 'user-choose'; // Flag f√ºr Merge-Prompt
  obj.timestamp = Date.now();
  obj.retryCount = 0;
});

// Conflict Resolution
async function syncWithConflictHandling() {
  const conflicts = await detectConflicts();
  if (conflicts.length > 0) {
    const resolution = await showConflictPrompt(conflicts);
    await applyResolution(resolution);
  }
}
```

- Service Worker cached Karten-Tiles und h√§ufige Threads
- Cache Strategy: tiles 'cache-first' (TTL: 24h), events 'network-first' (TTL: 5min)

### 1.7 Timeline (Zeitleiste)
- **Scrubber**: Untere Kante, Tagesschritte (‚Üê/‚Üí Pfeile)
- **Tages-Snapshots** (komprimiert: state_YYYYMMDD.json.gz)
- **Delta-Replays**: Optional via FF_TIMELINE_DELTA=true (SSE)
- **UI**: Tages-Scrubber, Play-Modus, respektiert Fadenarten, Fade, Garn
- **Visualisierung**: Opacity-Fade rekonstruiert, Read-Only Overlays

***

## 2) Dom√§ne & Regeln

### 2.1 Automatik-Grundsatz: Aktion ‚áí Faden
- **Jede aktive Nutzeraktion** an einem Karten-Knoten erzeugt automatisch einen Faden von dessen Rolle zum Handlungsort (Subtyp je Aktion)
- **Passive Aktionen** (nur ansehen/filtern) erzeugen **keine F√§den**
- **Login ist KEINE Karten-Aktion** ‚Üí erzeugt keinen Faden (Fadenpflicht bleibt unverletzt)

### 2.2 Knoten-Lebenszyklus (pr√§zisiert)
- **Garn sch√ºtzt Knoten**: Solange mindestens ein Garn zu einem Knoten f√ºhrt, verf√§llt der Knoten **nicht**
- **Verfall startet erst**, wenn letzter Faden/Garn entkn√ºpft/verblasst ist ‚Üí **KnotenStartetVerfall**, expires_at = now()+7d
- **Fade**: UI-Opacity steigt linear 0 ‚Üí 100% in 7 Tagen; dann **KnotenVerfallen** (Historie bleibt in Events/Timeline)

### 2.3 Governance (erweitert)
- **Antr√§ge**: AntragGestellt erzeugt **Antragsfaden** Rolle ‚Üí Ziel-Knoten (oder Konto-Knoten); Timer 7 Tage sichtbar
- **Einspruch (final + begrenzt)**: Ein Einspruch ‚áí **verbindliche finale Abstimmung in +7 Tagen** (AbstimmungTerminiert{ts}); **keine Kettenverl√§ngerungen**
  - **Einspruch-Limit**: Max. 1 Einspruch pro Rolle pro Antrag (verhindert Trolling)
- **Abstimmung**: AbstimmungGestartet zum Termin; Voting-Fenster (24‚Äì72h, per Instanz-Policy); StimmeAbgegeben erzeugt **Abstimmungsfaden**
- **Automatisches Quorum-Check**: Standard min 10% verifizierte Rollen; bei Nichterreichung ‚Üí **AntragPausiert** (nicht abgelehnt)
- **Delegation**: Phase A 1:1; Ablauf nach **4 Wochen Inaktivit√§t** des Delegierenden (Timer). Phase B (Flag): transitiv, Cycle-Check
- **Delegationsf√§den**: **Immer sichtbar** als graue Pfeile (keine Opt-out Option)

***

## 3) Event-Schema & Technische Architektur

### 3.1 Event-Schema (vollst√§ndig + Auth)

```json
{
  "id": "01HZXY9ABCDEFGHIJK",           // ULID
  "type": "FadenGesponnen",
  "subtype": "gespr√§ch",               // gespraech|gestaltung|veraenderung|antrag|abstimmung|gold|delegation
  "aggregateId": "knoten-550e8400-e29b-41d4-a716-446655440000",
  "aggregateType": "knoten",           // knoten|faden|rolle|antrag|delegation|zahlung|account|session
  "ts": "2025-08-19T15:22:00.000Z",
  "subject": "wg.kleinroennau.social", // √ñffentlich | "wg.kleinroennau.auth" f√ºr Login-Events
  "prev_hash": "abc123def456...",       // SHA256 des letzten Events f√ºr dieses Aggregat
  "payload": {
    "fromRolle": "rolle-uuid...",
    "toKnoten": "knoten-uuid...",
    "content": "Das ist interessant!",
    "expiresAt": "2025-08-26T15:22:00.000Z",
    "h3": 599405658847379
  },
  "meta": {
    "actor": "rolle-uuid...",
    "msgId": "deterministic-dedup-key", // F√ºr Idempotenz
    "ipHash": "sha256(ip+salt)",         // Pseudonymisiert
    "uaHash": "sha256(ua+salt)"
  }
}
```

### 3.2 Event-Typen (mit Subtypen + Auth)

**F√§den:**
- `FadenGesponnen{subtype ‚àà gespraech|gestaltung|veraenderung|antrag|abstimmung|gold|delegation}`
- `FadenVerzwirnt{fadenIds[]}` ‚Üí wird Garn (permanent)
- `FadenEntzwirnt{garnId}` (optional)
- `FadenVerfallen{fadenId}`

**Knoten:**
- `KnotenGeknuepft{typ, coords, content}` + `RaumEr√∂ffnet` (automatisch)
- `KnotenStartetVerfall` (wenn letzter Faden/Garn weg)
- `KnotenVerfallen`

**Governance (erweitert):**
- `AntragGestellt{title, content, weaveryH3}`
- `EinspruchEingegangen{grund, rolleId}` ‚Üí **Einspruch-Counter** ‚Üí `AbstimmungTerminiert{voteStartsAt}` (fix +7 Tage)
- `EinspruchAbgelehnt{reason: 'already_objected'}` (bei >1 Einspruch pro Rolle)
- `AbstimmungGestartet{deadline}` ‚Üí `StimmeAbgegeben{vote, delegatedFrom?}` ‚Üí `AbstimmungBeendet{result, quorumMet, quorumFallback?}`
- `AntragPausiert{reason: 'quorum_not_met'}` (statt Ablehnung)
- `DelegationErteilt{delegate, expiresAt}`, `DelegationWiderrufen`, `DelegationAbgelaufen`

**Finanz (Goldf√§den):**
- `GoldfadenInitiated{betragCents, referenz}` ‚Üí `GoldfadenPending` ‚Üí `GoldfadenSettled{settledAt}`
- `GoldfadenFailed{reason}`, `GoldfadenReversed{reason}`

**Auth-Events (privater subject "wg.kleinroennau.auth"):**
- `LoginInitiated{method, deviceId?}`
- `MagicLinkSent{emailHash}`
- `LoginSucceeded{method, accountId, sessionId}`
- `LoginFailed{method, reason}`
- `SessionCreated{sessionId, accountId, expiresAt}`
- `SessionRenewed{sessionId, expiresAt}`
- `SessionRevoked{sessionId, reason}`
- `AccountCreated{accountId, rolleId}`

**System & Ops:**
- `EventRejected{originalEvent, reason}` ‚Üí DLQ
- `AdminActionExecuted{action, reason}` (Transparenz)
- `FallbackActivated{reason}` ‚Üí Redis-Fallback aktiv
- `SystemAlert{level, message}`, `KostenAktualisiert{monatEur}`
- `SnapshotErstellt{day, compressedSize}`

### 3.3 Aktion‚ÜíEvent‚ÜíFaden Mapping (erweitert)

| Benutzeraktion | Event(s) | Automatischer Faden | Fadenart |
|---|---|---|---|
| Kommentar in Raum | `FadenGesponnen{gespr√§ch}` | Ja | Gespr√§chsfaden |
| Knoten kn√ºpfen | `KnotenGekn√ºpft` + `FadenGesponnen{gestaltung}` | Ja | Gestaltungsfaden |
| Knoten bearbeiten | `FadenGesponnen{ver√§nderung}` | Ja | Ver√§nderungsfaden |
| Antrag stellen | `AntragGestellt` + `FadenGesponnen{antrag}` | Ja | Antragsfaden |
| Einspruch | `EinspruchEingegangen` (+ Counter-Check) | Nein | - |
| Abstimmen | `StimmeAbgegeben` + `FadenGesponnen{abstimmung}` | Ja | Abstimmungsfaden |
| Spenden | `GoldfadenInitiated` + `FadenGesponnen{gold}` | Ja | Goldfaden |
| Delegieren | `DelegationErteilt` + `FadenGesponnen{delegation}` | Ja | **Delegationsfaden (immer sichtbar)** |
| Verzwirnen | `FadenVerzwirnt` | Nein | Garn-Upgrade |
| **Login** | `LoginSucceeded` + `SessionCreated` | **Nein** | **Kein Faden** |

### 3.4 Timer-Automatik (erweitert)
- **Einspruch ‚áí Abstimmung**: bei EinspruchEingegangen ‚Üí schedule AbstimmungGestartet bei now()+7d
- **Delegation Expiry**: 4 Wochen Inaktivit√§t des Delegierenden ‚Üí DelegationAbgelaufen
- **Knoten-Fade**: on letzter Link weg ‚Üí KnotenStartetVerfall ‚Üí 7 Tage ‚Üí KnotenVerfallen
- **Session-Sweeper**: alle 15 min ‚Üí abgelaufene Sessions ‚Üí SessionRevoked{reason:"expired"}
- **Chain-Crawler** (n√§chtlich): Stichprobe Hash-Ketten-Validierung (24h Lookback), Prio-1 Alert bei Inkonsistenzen

***

## 4) System-Architektur & Implementation

### 4.1 System-√úberblick (ASCII)

```
[SvelteKit PWA + MapLibre + ServiceWorker + Dexie]
   ‚îÇ  HTTPS/WSS (TLS 1.3, CSP strict)
   ‚ñº
[NGINX + Varnish] ‚îÄ‚îÄ‚Üí [Fastify API + @fastify/websocket]
   ‚îÇ                      ‚îÇ  Zod-Validation, Commands‚ÜíEvents
   ‚îÇ                      ‚îÇ  Auth: WebAuthn + Magic-Link + Session
   ‚îÇ                      ‚ñº
   ‚îÇ              [EventBus Adapter]
   ‚îÇ                ‚îú‚îÄ‚Üí [NATS JetStream] (Primary SoR)
   ‚îÇ                ‚îî‚îÄ‚Üí [Redis Streams] (Auto-Fallback + Sessions)
   ‚îÇ                      ‚îÇ
   ‚îÇ                      ‚îú‚îÄ‚Üí [worker-projection] (scale: 1-3)
   ‚îÇ                      ‚îÇ     ‚îî‚îÄ‚Üí [PostgreSQL + PostGIS]
   ‚îÇ                      ‚îÇ
   ‚îÇ                      ‚îî‚îÄ‚Üí [worker-jobs] (scale: 1)
   ‚îÇ                            ‚îú‚îÄ‚Üí [BullMQ Timer] (7d/4w expiry + session sweep)
   ‚îÇ                            ‚îî‚îÄ‚Üí [FinTS Poller] (4h + backoff)
   ‚îÇ
   ‚îî‚îÄ‚Üí [Prometheus + Grafana + Alertmanager]
         ‚îî‚îÄ‚Üí [Signal/Matrix Webhook]
```

### 4.2 EventBus Adapter mit Auto-Fallback

```typescript
class EventBus {
  async publish(event: Event): Promise<void> {
    // Hash-Chain Validation
    const lastEvent = await this.getLastEventForAggregate(event.aggregateId);
    const expectedHash = lastEvent?.hash ?? null;
    if (event.prev_hash !== expectedHash) {
      return this.publishDLQ({
        type: 'EventRejected',
        reason: 'invalid_prev_hash',
        originalEvent: event
      });
    }

    try {
      // Primary: NATS JetStream
      await this.natsJs.publish(event.subject, JSON.stringify(event), {
        msgID: event.meta.msgId
      });
    } catch (error) {
      // Fallback: Redis Streams
      const dedupKey = `dedupe:${event.meta.msgId}`;
      await this.redis.setEx(dedupKey, 120, '1');
      await this.redis.xAdd(event.subject, '*', {  JSON.stringify(event) });
      
      // Transparency Event
      await this.publishDLQ({
        type: 'FallbackActivated',
        reason: error.message,
        timestamp: new Date().toISOString()
      });
    }

    // Update Hash-Chain Cache
    await this.updateAggregateHash(event.aggregateId, sha256(JSON.stringify(event)));
  }
}
```

### 4.3 Database Schema (PostgreSQL + PostGIS + Auth)

```sql
-- Enums f√ºr Konsistenz
CREATE TYPE knoten_typ AS ENUM ('idee','veranstaltung','ressource','schlafplatz','webrat','n√§hst√ºbchen','konto');
CREATE TYPE faden_subtype AS ENUM ('gespr√§ch','gestaltung','ver√§nderung','antrag','abstimmung','gold','delegation');
CREATE TYPE antrag_status AS ENUM ('offen','abstimmung_terminiert','abstimmung_l√§uft','angenommen','abgelehnt','pausiert','quorum_verfehlt');
CREATE TYPE vote_choice AS ENUM ('ja','nein','enthaltung');
CREATE TYPE zahlung_status AS ENUM ('initiated','pending','settled','failed','reversed');

-- Core Tables
CREATE TABLE rollen (
  id UUID PRIMARY KEY,
  name TEXT NOT NULL,
  coords GEOGRAPHY(POINT) NOT NULL,
  h3 BIGINT NOT NULL,
  verified_by UUID[] DEFAULT '{}',
  verified_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE knoten (
  id UUID PRIMARY KEY,
  typ knoten_typ NOT NULL,
  title TEXT NOT NULL,
  content JSONB,
  coords GEOGRAPHY(POINT) NOT NULL,
  h3 BIGINT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  kind TEXT CHECK (kind IN ('standard','konto','webrat','naehstuebchen')),
  fade_started_at TIMESTAMPTZ,           -- KnotenStartetVerfall
  expires_at TIMESTAMPTZ,                -- KnotenVerfallen in 7d
  last_linked_at TIMESTAMPTZ,
  is_permanent BOOLEAN DEFAULT FALSE     -- Hat Garn ‚Üí nie verfall
);

CREATE TABLE faeden (
  id UUID PRIMARY KEY,
  from_rolle UUID REFERENCES rollen(id) NOT NULL,
  to_knoten UUID REFERENCES knoten(id) NOT NULL,
  subtype faden_subtype NOT NULL,
  content TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  expires_at TIMESTAMPTZ NOT NULL,
  is_garn BOOLEAN DEFAULT FALSE          -- Verzwirnt ‚Üí permanent
);

CREATE TABLE antraege (
  id UUID PRIMARY KEY,
  autor UUID REFERENCES rollen(id) NOT NULL,
  weavery_h3 BIGINT NOT NULL,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  status antrag_status DEFAULT 'offen',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  einspruch_deadline TIMESTAMPTZ,        -- 7 Tage f√ºr Veto
  einspruch_count INTEGER DEFAULT 0,     -- Max 1 pro Rolle
  vote_scheduled_at TIMESTAMPTZ,         -- Nach Einspruch fix terminiert
  vote_starts_at TIMESTAMPTZ,
  vote_deadline TIMESTAMPTZ,
  decision_at TIMESTAMPTZ
);

CREATE TABLE einsprueche (
  id UUID PRIMARY KEY,
  antrag_id UUID REFERENCES antraege(id) NOT NULL,
  rolle_id UUID REFERENCES rollen(id) NOT NULL,
  grund TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(antrag_id, rolle_id)            -- Max 1 Einspruch pro Rolle/Antrag
);

CREATE TABLE stimmen (
  id UUID PRIMARY KEY,
  antrag_id UUID REFERENCES antraege(id) NOT NULL,
  rolle_id UUID REFERENCES rollen(id) NOT NULL,
  vote vote_choice NOT NULL,
  delegated_from UUID REFERENCES rollen(id), -- Falls √ºber Delegation
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(antrag_id, rolle_id)            -- Idempotenz
);

CREATE TABLE delegationen (
  id UUID PRIMARY KEY,
  from_rolle UUID REFERENCES rollen(id) NOT NULL,
  to_rolle UUID REFERENCES rollen(id) NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  expires_at TIMESTAMPTZ NOT NULL,       -- +4 Wochen
  UNIQUE(from_rolle)                     -- Nur eine aktive Delegation
);

CREATE TABLE zahlungen (
  id UUID PRIMARY KEY,
  rolle_id UUID REFERENCES rollen(id) NOT NULL,
  betrag_cents INTEGER NOT NULL,
  waehrung CHAR(3) DEFAULT 'EUR',
  status zahlung_status DEFAULT 'initiated',
  provider_ref TEXT,                     -- SEPA/FinTS/Stripe Reference
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  settled_at TIMESTAMPTZ
);

CREATE TABLE raeume (
  id UUID PRIMARY KEY,
  knoten_id UUID REFERENCES knoten(id) UNIQUE NOT NULL, -- 1:1 Beziehung
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Auth Tables
CREATE TABLE accounts (
  id UUID PRIMARY KEY,
  primary_email_hash TEXT,              -- sha256(normalizedEmail + EMAIL_SALT)
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  rolle_id UUID UNIQUE NOT NULL REFERENCES rollen(id)  -- 1:1 in Phase A
);

CREATE TABLE sessions (
  id UUID PRIMARY KEY,
  account_id UUID NOT NULL REFERENCES accounts(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  expires_at TIMESTAMPTZ NOT NULL,
  user_agent_hash TEXT,
  ip_hash TEXT
);

CREATE TABLE webauthn_credentials (
  id TEXT PRIMARY KEY,                   -- credentialId (Base64URL)
  account_id UUID NOT NULL REFERENCES accounts(id),
  public_key TEXT NOT NULL,
  sign_count BIGINT NOT NULL DEFAULT 0,
  transports TEXT[],
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(account_id, id)
);

-- Event Archive (partitioned)
CREATE TABLE events_archive (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,
  subtype TEXT,
  aggregate_id TEXT NOT NULL,
  aggregate_type TEXT NOT NULL,
  ts TIMESTAMPTZ NOT NULL,
  subject TEXT NOT NULL,
  prev_hash TEXT,
  payload JSONB NOT NULL,
  meta JSONB NOT NULL
) PARTITION BY RANGE (ts);

-- Performance Indices
CREATE INDEX ON rollen (h3);
CREATE INDEX ON knoten (h3, created_at);
CREATE INDEX ON knoten (expires_at) WHERE expires_at IS NOT NULL;
CREATE INDEX ON faeden (to_knoten, subtype);
CREATE INDEX ON faeden (expires_at) WHERE NOT is_garn;
CREATE INDEX ON antraege (weavery_h3, status);
CREATE INDEX ON antraege (vote_scheduled_at);
CREATE INDEX ON einsprueche (antrag_id, rolle_id);
CREATE INDEX ON stimmen (antrag_id, created_at);
CREATE INDEX ON delegationen (to_rolle, expires_at);
CREATE INDEX ON accounts (primary_email_hash);
CREATE INDEX ON sessions (account_id, expires_at);
CREATE INDEX ON events_archive (aggregate_id, ts);
CREATE INDEX ON events_archive (subject, ts);
```

### 4.4 API-Vertrag (REST + Auth)

```typescript
// Auth Endpoints
POST   /auth/magic/start         { email }              -> 200 (immer), Event: MagicLinkSent
GET    /auth/magic/callback?token=...                   -> 302 (‚Üí /), Events: LoginSucceeded + SessionCreated
POST   /auth/webauthn/register/options                  -> { publicKey }
POST   /auth/webauthn/register/verify                   -> 201 AccountCreated + SessionCreated
POST   /auth/webauthn/login/options                     -> { publicKey }
POST   /auth/webauthn/login/verify                      -> 200 LoginSucceeded + SessionCreated
GET    /auth/oidc/start                                 -> (optional)
GET    /auth/oidc/callback                              -> SessionCreated
POST   /auth/logout                                     -> SessionRevoked
GET    /auth/me                                         -> { account, rolle, verified }

// Commands (POST) - mit Session-Validierung
POST /api/knoten { title, kind?, geometry, ... }          -> KnotenGeknuepft + FadenGesponnen{gestaltung}
POST /api/faeden { toKnotenId, subtype }                   -> FadenGesponnen{subtype}
POST /api/faeden/:id/verzwirnen                            -> FadenVerzwirnt (=> is_garn=true)
POST /api/antraege { zielKnotenId, title, ... }            -> AntragGestellt + FadenGesponnen{antrag}
POST /api/antraege/:id/einspruch                           -> EinspruchEingegangen (mit Counter-Check)
POST /api/antraege/:id/stimme { vote }                     -> StimmeAbgegeben + FadenGesponnen{abstimmung}
POST /api/spenden { betrag, referenz }                     -> GoldfadenInitiated -> Pending/Settled...
POST /api/delegation { toUserId }                          -> DelegationErteilt (Phase A: 1:1)

// Queries (GET)
GET  /api/karte?h3=...&zoom=...&filter=...     # Tiles + Events f√ºr Viewport + Fadenarten-Filter
GET  /api/timeline/:day                         # Snapshot + optional Delta
GET  /api/raum/:knotenId/threads                # Thread-Liste mit Pagination
GET  /api/antraege?status=offen                 # Governance-√úbersicht
GET  /replay/snapshot?day=YYYY-MM-DD            -> Tages-Snapshot
GET  /replay/delta?since=ISO&until=ISO (SSE)   -> Delta-Events (optional aktiv)

// System
GET  /health/live    # Prozess lebt
GET  /health/ready   # PG+NATS+Redis OK
GET  /metrics        # Prometheus Endpoint
```

### 4.5 Session-Management (Fastify Plugin)

```typescript
// apps/api/src/plugins/session.ts
import fastifyCookie from '@fastify/cookie';
import { randomBytes } from 'crypto';

export default async function sessionPlugin(app) {
  app.register(fastifyCookie, { 
    secret: process.env.SESSION_SECRET, 
    hook: 'onRequest' 
  });

  app.decorateRequest('session', null);
  app.addHook('onRequest', async (req, reply) => {
    const sid = req.cookies['wg_session'];
    if (!sid) return;
    
    const sess = await redis.get(`wg:sess:${sid}`);
    if (!sess) return;
    
    const sessionData = JSON.parse(sess);
    if (new Date(sessionData.expiresAt) < new Date()) {
      await redis.del(`wg:sess:${sid}`);
      return;
    }
    
    req.session = sessionData;
  });

  app.decorateReply('createSession', async (accountId: string) => {
    const sid = randomBytes(24).toString('hex');
    const expiresAt = new Date(Date.now() + 14*24*3600*1000);
    
    await redis.set(`wg:sess:${sid}`, JSON.stringify({ 
      accountId, 
      expiresAt,
      createdAt: new Date()
    }), { EX: 14*24*3600 });
    
    reply.setCookie('wg_session', sid, {
      path: '/', 
      httpOnly: true, 
      sameSite: 'strict', 
      secure: true, 
      maxAge: 14*24*3600
    });
    
    // Events (privater subject)
    await eventBus.publish({ 
      type: 'SessionCreated', 
      aggregateId: sid, 
      subject: 'wg.kleinroennau.auth',
      payload: { accountId, expiresAt } 
    });
  });
}
```

### 4.6 Workers (getrennte Lastprofile + Auth)

**worker-projection (horizontal skalierbar):**
```typescript
class ProjectionWorker {
  async handleEvent(event: Event) {
    switch (event.type) {
      case 'FadenGesponnen':
        await this.createFaden(event);
        await this.scheduleExpiry(event.payload.expiresAt, event.id);
        break;
      
      case 'FadenVerzwirnt':
        await this.markAsGarn(event.payload.fadenIds);
        await this.cancelExpiryTimers(event.payload.fadenIds);
        break;
      
      case 'KnotenGekn√ºpft':
        await this.createKnoten(event);
        await this.createRaum(event.aggregateId); // Automatisch!
        break;
      
      case 'EinspruchEingegangen':
        // Counter-Check f√ºr Max 1 pro Rolle
        const existing = await db.query(
          'SELECT count(*) FROM einsprueche WHERE antrag_id = $1 AND rolle_id = $2',
          [event.payload.antragId, event.payload.rolleId]
        );
        if (existing.rows[0].count > 0) {
          await eventBus.publish({
            type: 'EinspruchAbgelehnt',
            reason: 'already_objected'
          });
          return;
        }
        await this.processEinspruch(event);
        break;
        
      case 'AbstimmungBeendet':
        // Quorum-Check mit Fallback
        const quorumMet = await this.checkQuorum(event.payload);
        if (!quorumMet.success) {
          await eventBus.publish({
            type: 'AntragPausiert',
            aggregateId: event.payload.antragId,
            payload: { reason: 'quorum_not_met', requiredQuorum: quorumMet.required }
          });
        }
        break;
        
      // ... weitere Event-Handler
    }
    
    // H3 Speed-Layer Update
    await this.updateH3Counters(event.payload.h3);
  }
}
```

**worker-jobs (singleton, zeitkritisch + Auth):**
```typescript
class JobsWorker {
  async setupQueues() {
    // Verfall-Timer
    this.verfallQueue = new Queue('verfall', { connection: redis });
    this.verfallQueue.process('faden-verfall', this.handleFadenVerfall.bind(this));
    
    // Einspruch ‚Üí Abstimmung Timer
    this.governanceQueue = new Queue('governance', { connection: redis });
    this.governanceQueue.process('start-vote', this.handleStartVote.bind(this));
    
    // Session-Sweeper (neu)
    this.sessionQueue = new Queue('sessions', { connection: redis });
    this.sessionQueue.add('sweep-expired', {}, {
      repeat: { every: 15 * 60 * 1000 } // 15min
    });
    this.sessionQueue.process('sweep-expired', this.handleSessionSweep.bind(this));
    
    // FinTS Poller
    this.fintsQueue = new Queue('fints', { connection: redis });
    this.fintsQueue.add('poll-transactions', {}, { 
      repeat: { every: 4 * 60 * 60 * 1000 }, // 4h
      backoff: { type: 'exponential', delay: 2000 }
    });
    
    // Chain-Crawler (n√§chtlich)
    this.crawlerQueue = new Queue('crawler', { connection: redis });
    this.crawlerQueue.add('validate-chains', {}, {
      repeat: { cron: '30 2 * * *' } // 02:30 daily
    });
  }

  async handleSessionSweep(job: Job) {
    // Abgelaufene Sessions finden und revoken
    const expiredSessions = await db.query(
      'SELECT id FROM sessions WHERE expires_at < now()'
    );
    
    for (const session of expiredSessions.rows) {
      await redis.del(`wg:sess:${session.id}`);
      await eventBus.publish({
        type: 'SessionRevoked',
        aggregateId: session.id,
        subject: 'wg.kleinroennau.auth',
        payload: { reason: 'expired' }
      });
    }
    
    // Cleanup DB
    await db.query('DELETE FROM sessions WHERE expires_at < now()');
  }
}
```

***

## 5) Sicherheit & Datenschutz

### 5.1 Auth-Strategie (datensparsam)
- **Prim√§r**: WebAuthn Passkeys (Philosophie-konform, datensparsam)
- **Fallback**: Magic-Link (SMTP, throttled), OIDC optional (eigener IdP, keine 3rd-party Tracker)
- **Sessions**: Cookie-basiert, HTTP-only, SameSite=Strict, Secure, rotierende Session-IDs
- **Keine Passw√∂rter**: Nur Passkeys/Magic-Links

### 5.2 Peer-Verifikation (2-von-N)

```typescript
export class VerificationService {
  async startVerification(kandidatId: string, verifierId: string) {
    // Pr√ºfe Berechtigung des Verifierers
    const verifier = await db.query(
      'SELECT verified_by FROM rollen WHERE id = $1', 
      [verifierId]
    );
    
    if (verifier.rows[0]?.verified_by.length < 2) {
      throw new Error('Verifierer muss selbst verifiziert sein');
    }
    
    await eventBus.publish({
      type: 'VerificationStarted',
      aggregateId: kandidatId,
      payload: { verifier: verifierId, method: 'peer' }
    });
  }
  
  async completeVerification(kandidatId: string, verifiers: string[]) {
    if (verifiers.length < 2) {
      throw new Error('Mindestens 2 Verifizierer erforderlich');
    }
    
    // Anti-Sybil: Verifizierer d√ºrfen nicht alle aus derselben H3-Zelle
    const h3Cells = await db.query(`
      SELECT DISTINCT h3 FROM rollen WHERE id = ANY($1)
    `, [verifiers]);
    
    if (h3Cells.rows.length < 2) {
      throw new Error('Verifizierer m√ºssen aus verschiedenen Gebieten kommen');
    }
    
    return eventBus.publish({
      type: 'RolleVerifiziert',
      aggregateId: kandidatId,
      payload: { 
        verifiedBy: verifiers, 
        method: 'peer',
        verifiedAt: new Date().toISOString()
      }
    });
  }
}
```

### 5.3 Datenschutz Implementation (erweitert)

```typescript
export class PrivacyUtils {
  private static salt = process.env.PRIVACY_SALT!;
  private static emailSalt = process.env.EMAIL_SALT!;
  
  static hashIP(ip: string): string {
    return crypto.createHash('sha256')
      .update(ip + this.salt)
      .digest('hex');
  }
  
  static hashEmail(email: string): string {
    const normalized = email.toLowerCase().trim();
    return crypto.createHash('sha256')
      .update(normalized + this.emailSalt)
      .digest('hex');
  }
  
  static async handleUserDeleted(rolleId: string) {
    // DSGVO Export vorher erstellen
    const exportData = await this.createUserExport(rolleId);
    await this.storeExportForDownload(rolleId, exportData);
    
    // Pseudonymisierung: Events bleiben, aber Actor wird anonymisiert
    await db.query(`
      UPDATE events_archive 
      SET meta = jsonb_set(meta, '{actor}', '"anonymous-${substr(md5($1), 1, 8)}"')
      WHERE meta->>'actor' = $1
    `, [rolleId]);
    
    // Account/Session cleanup
    const account = await db.query('SELECT id FROM accounts WHERE rolle_id = $1', [rolleId]);
    if (account.rows) {
      await db.query('DELETE FROM sessions WHERE account_id = $1', [account.rows.id]);
      await db.query('DELETE FROM webauthn_credentials WHERE account_id = $1', [account.rows.id]);
      await db.query('DELETE FROM accounts WHERE id = $1', [account.rows.id]);
    }
    
    return eventBus.publish({
      type: 'UserDeleted',
      aggregateId: rolleId,
      payload: { anonymized: true, exportAvailable: true }
    });
  }
}
```

***

## 6) Observability & Monitoring

### 6.1 Prometheus Metriken (erweitert)

```typescript
export const metrics = {
  // Event Metrics
  eventsTotal: new Counter({
    name: 'wg_events_total',
    help: 'Total number of events published',
    labelNames: ['type', 'subtype', 'stream']
  }),
  
  // Auth Metrics (neu)
  authLoginsSucceeded: new Counter({
    name: 'wg_auth_logins_succeeded_total',
    help: 'Successful logins',
    labelNames: ['method']
  }),
  
  authLoginsFailed: new Counter({
    name: 'wg_auth_logins_failed_total',
    help: 'Failed logins',
    labelNames: ['method', 'reason']
  }),
  
  authSessionsActive: new Gauge({
    name: 'wg_auth_sessions_active',
    help: 'Active sessions'
  }),
  
  authMagicSent: new Counter({
    name: 'wg_auth_magic_sent_total',
    help: 'Magic links sent'
  }),
  
  // Dom√§nen-spezifische Metrics
  activeKnoten: new Gauge({
    name: 'wg_knoten_active',
    help: 'Currently active Knoten (not expired)'
  }),
  
  fadenByType: new Gauge({
    name: 'wg_faeden_by_type',
    help: 'Active F√§den by subtype',
    labelNames: ['subtype']
  }),
  
  knotenFadeActive: new Gauge({
    name: 'wg_knoten_fade_active',
    help: 'Knoten currently fading (expires_at set)'
  }),
  
  voteScheduledTotal: new Gauge({
    name: 'wg_vote_scheduled_total',
    help: 'Antr√§ge with scheduled votes'
  }),
  
  governanceActive: new Gauge({
    name: 'wg_governance_active_antraege',
    help: 'Active Antr√§ge requiring action'
  }),
  
  // Community Health (neu)
  npsScoreAverage: new Gauge({
    name: 'wg_nps_score_average',
    help: 'Average NPS score from community surveys'
  }),
  
  // Kosten Metrics
  costsMonthEur: new Gauge({
    name: 'wg_costs_month_eur',
    help: 'Monthly infrastructure cost in EUR'
  }),
  
  costPerKEvents: new Gauge({
    name: 'wg_cost_per_1k_events',
    help: 'Cost per 1000 events (30d average)'
  })
};

// NPS Score Collection
async function collectNPSScore() {
  const surveys = await db.query(`
    SELECT avg(score) as avg_score 
    FROM nps_surveys 
    WHERE created_at > now() - interval '30 days'
  `);
  
  if (surveys.rows?.avg_score) {
    metrics.npsScoreAverage.set(parseFloat(surveys.rows.avg_score));
  }
}
```

### 6.2 Alerting Rules (erweitert)

```yaml
# alerts.yml
groups:
- name: weltgewebe.rules
  rules:
  # Auth Alerts (neu)
  - alert: AuthFailureSpike
    expr: increase(wg_auth_logins_failed_total[5m]) > 20
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Unusual auth failure spike"
      description: "{{ $value }} failed logins in 5 minutes"
      
  - alert: SessionStoreDown
    expr: wg_auth_sessions_active < 1 and up{job="api"} == 1 and increase(wg_auth_logins_succeeded_total[10m]) > 0
    for: 10m
    labels:
      severity: critical
    annotations:
      summary: "Sessions collapsed while API is up"
      
  # Application Logic
  - alert: VoteOhneTermin
    expr: wg_governance_active_antraege > 0 and wg_vote_scheduled_total == 0
    for: 1h
    labels:
      severity: warning
    annotations:
      summary: "Antrag ohne terminierte Abstimmung"
      
  - alert: KnotenOhneLinksOhneFade
    expr: wg_knoten_active > wg_knoten_fade_active and rate(wg_events_total{type="FadenVerfallen"}[1h]) == 0
    for: 30m
    labels:
      severity: warning
    annotations:
      summary: "Knoten ohne Links ohne Fade-Start"
      
  - alert: DelegationsExpiryDrift
    expr: increase(wg_events_total{type="DelegationAbgelaufen"}[24h]) == 0 
          and increase(wg_events_total{type="DelegationErteilt"}[7d]) > 0
    for: 2h
    labels:
      severity: info
    annotations:
      summary: "Delegations-Expiry Timer m√∂glicherweise gestoppt"
      
  # Community Health (neu)
  - alert: NPSScoreLow
    expr: wg_nps_score_average < 3.0
    for: 24h
    labels:
      severity: warning
    annotations:
      summary: "Community NPS score below threshold"
      description: "Average NPS: {{ $value }}, target: >=4.0"
      
  - alert: KostenZuHoch
    expr: wg_costs_month_eur > 35
    for: 10m
    labels:
      severity: critical
    annotations:
      summary: "Monatliche Kosten √ºberschreiten ‚Ç¨35"
```

***

## 7) Runbooks & Operations

### 7.1 MTTR-orientierte Checklisten

**üö® NATS down (MTTR ‚â§15 min)**
```markdown
# NATS Server Down

## Immediate Response
1. **Check Fallback Status** (2 min)
   ```
   curl -s localhost:3000/health/ready | jq .nats
   # Should show "fallback_active": true
   ```
   
2. **Diagnose NATS** (3 min)
   ```
   nats server report
   nats stream report
   docker logs nats-container --tail=50
   ```
   
3. **Restart Service** (5 min)
   ```
   docker-compose restart nats
   docker-compose ps nats
   ```
   
4. **Verify Recovery** (5 min)
   ```
   nats stream report
   curl localhost:3000/health/ready
   ```
```

**üîê Auth-Probleme (MTTR ‚â§15 min)**
```markdown
# Auth System Issues

## SMTP down
1. **Check logs** (2 min)
   ```
   docker logs smtp --tail=100
   netstat -tlnp | grep :587
   ```
   
2. **Test Magic-Link** (3 min)
   ```
   curl -X POST localhost:3000/auth/magic/start -d '{"email":"test@example.com"}'
   # Status 200, check email delivery
   ```
   
3. **Fallback Provider** (5 min)
   Update SMTP_DSN environment variable
   
## WebAuthn Fehler
1. **Check Origin/RP-ID** (2 min)
   Browser dev tools ‚Üí Security tab
   
2. **Server time sync** (1 min)
   ```
   ntpdate -s time.nist.gov
   ```
   
3. **Browser console** (2 min)
   Check for SecurityError messages
```

**üìä Consumer Lag >1s (MTTR ‚â§15 min)**
```markdown
# High Consumer Lag

## Immediate Response
1. **Scale Projection Workers** (2 min)
   ```
   docker-compose up -d --scale worker-projection=3
   ```
   
2. **Check Database Performance** (3 min)
   ```
   SELECT query, mean_time, calls 
   FROM pg_stat_statements 
   ORDER BY mean_time DESC LIMIT 10;
   ```
   
3. **Monitor Recovery** (10 min)
   - Target: <1s within 5 minutes
```

**üó≥Ô∏è Governance-Tests**
```markdown
# Governance Flow Verification

## Einspruch ‚Üí Abstimmung Test
1. **EinspruchEingegangen triggert AbstimmungTerminiert(+7d)?**
2. **Counter-Check: Max 1 Einspruch pro Rolle funktioniert?**
3. **Quorum-Fallback: AntragPausiert bei Nichterreichung?**
```

### 7.2 Health Check Implementation (erweitert)

```typescript
app.get('/health/ready', async (request, reply) => {
  const checks = await Promise.allSettled([
    db.query('SELECT 1'),
    natsJs.jetstreamManager().streams.info('wg_kleinroennau_social'),
    redis.ping(),
    eventBus.healthCheck(),
    // Auth-spezifisch
    redis.get('test-session-key').then(() => true), // Session-Store
    db.query('SELECT count(*) FROM accounts LIMIT 1') // Auth-DB
  ]);

  const results = {
    postgresql: checks.status === 'fulfilled',
    nats: checks[1].status === 'fulfilled',
    redis: checks[2].status === 'fulfilled', 
    eventbus: checks[3].status === 'fulfilled',
    sessionStore: checks.status === 'fulfilled',
    authDb: checks.status === 'fulfilled',
    fallback_active: eventBus.isInFallbackMode(),
    timestamp: new Date().toISOString()
  };

  const healthy = Object.values(results).every(v => 
    v === true || v === results.timestamp || v === results.fallback_active
  );

  return reply.code(healthy ? 200 : 503).send(results);
});
```

***

## 8) Tests & Quality Gates

### 8.1 E2E Tests (Playwright, erweitert)

```typescript
// tests/e2e/auth-flow.spec.ts
test('Magic-Link Login dreht Rolle (oder Glow bei reduced motion)', async ({ page, context }) => {
  await page.goto('/');
  await page.click('[data-testid="login-button"]');
  await page.fill('[data-testid="email-input"]', 'test@example.org');
  await page.click('[data-testid="magic-send"]');
  
  // Simulate callback navigation
  await page.goto('/auth/magic/callback?token=TESTTOKEN');
  
  // Karte sichtbar & Marker animiert
  await expect(page.locator('[data-testid="roll-marker"]')).toHaveClass(/spin/);
});

test('WebAuthn Login erstellt Session & dreht Rolle', async ({ page }) => {
  // Mock WebAuthn via browser context
  await page.addInitScript(() => {
    navigator.credentials = {
      create: () => Promise.resolve({ id: 'test-credential' }),
      get: () => Promise.resolve({ id: 'test-credential', response: {} })
    };
  });
  
  await page.goto('/auth/webauthn');
  await page.click('[data-testid="passkey-login"]');
  await expect(page.locator('[data-testid="roll-marker"]')).toHaveClass(/spin/);
});

// tests/e2e/faden-automatik.spec.ts
test('Aktion ‚áí Faden (alle Subtypen)', async ({ page }) => {
  await page.goto('/');
  await page.click('[data-testid="login-button"]'); // Login first
  
  // Kommentar ‚Üí Gespr√§chsfaden
  await page.click('[data-testid="knoten-marker"]');
  await page.fill('[data-testid="kommentar-input"]', 'Test Kommentar');
  await page.click('[data-testid="kommentar-submit"]');
  await expect(page.locator('[data-testid="gespraech-faden"]')).toBeVisible();
  
  // Delegation ‚Üí Delegationsfaden (immer sichtbar)
  await page.click('[data-testid="delegation-erteilen"]');
  await expect(page.locator('[data-testid="delegation-faden"]')).toBeVisible();
});

test('Erweiterte Suche mit Fadenarten-Filter', async ({ page }) => {
  await page.goto('/');
  await page.click('[data-testid="filter-tab"]');
  
  // Nur Gestaltungsf√§den anzeigen
  await page.uncheck('[data-testid="filter-gespraech"]');
  await page.uncheck('[data-testid="filter-antrag"]');
  await page.check('[data-testid="filter-gestaltung"]');
  
  // Suche sollte nur Gestaltungsf√§den zeigen
  await page.fill('[data-testid="search-input"]', 'Knoten');
  await expect(page.locator('[data-testid="gestaltung-faden"]')).toBeVisible();
  await expect(page.locator('[data-testid="gespraech-faden"]')).not.toBeVisible();
});

test('Einspruch-Limit: Max 1 pro Rolle/Antrag', async ({ page }) => {
  // Ersten Einspruch einlegen
  await page.click('[data-testid="antrag-item"]');
  await page.click('[data-testid="einspruch-button"]');
  await page.fill('[data-testid="einspruch-grund"]', 'Bedarf weitere Diskussion');
  await page.click('[data-testid="einspruch-submit"]');
  
  // Zweiter Einspruch sollte fehlschlagen
  await page.click('[data-testid="einspruch-button"]');
  await expect(page.locator('[data-testid="error-already-objected"]')).toBeVisible();
});

test('Quorum-Fallback: AntragPausiert bei Nichterreichung', async ({ page }) => {
  // Abstimmung mit unzureichendem Quorum
  await page.click('[data-testid="antrag-item"]');
  await page.click('[data-testid="vote-ja"]');
  await page.click('[data-testid="vote-submit"]');
  
  // Nach Deadline sollte Antrag pausiert werden (nicht abgelehnt)
  await page.waitForTimeout(5000); // Simulate deadline
  await expect(page.locator('[data-testid="antrag-status"]')).toContainText('pausiert');
});

test('Garn-Schutz verhindert Knoten-Verfall', async ({ page }) => {
  // Knoten erstellen
  await page.click('[data-testid="knoten-knuepfen"]');
  
  // Faden verzwirnen zu Garn
  await page.click('[data-testid="faden-marker"]');
  await page.click('[data-testid="verzwirnen-button"]');
  await expect(page.locator('[data-testid="garn-marker"]')).toBeVisible();
  
  // Simulate 7 Tage sp√§ter - Knoten sollte NICHT verblassen
  await page.evaluate(() => {
    window.testAdvanceTime(7 * 24 * 60 * 60 * 1000);
  });
  
  await expect(page.locator('[data-testid="knoten-marker"]')).toBeVisible();
  await expect(page.locator('[data-testid="knoten-marker"]')).not.toHaveClass(/fading/);
});

test('Offline-Konfliktl√∂sung mit User-Prompt', async ({ page }) => {
  // Offline gehen
  await page.context().setOffline(true);
  
  // Aktion ausf√ºhren
  await page.click('[data-testid="knoten-bearbeiten"]');
  await page.fill('[data-testid="titel-input"]', 'Offline √Ñnderung');
  await page.click('[data-testid="speichern"]');
  
  // Online gehen mit Konflikt
  await page.context().setOffline(false);
  
  // Konflikt-Prompt sollte erscheinen
  await expect(page.locator('[data-testid="conflict-prompt"]')).toBeVisible();
  await page.click('[data-testid="resolve-keep-local"]');
  
  // √Ñnderung sollte √ºbernommen werden
  await expect(page.locator('[data-testid="titel-display"]')).toContainText('Offline √Ñnderung');
});
```

### 8.2 Load Tests (k6, erweitert)

```javascript
// tests/load/auth-performance.js
export let options = {
  stages: [
    { duration: '5m', target: 100 }, // Ramp up
    { duration: '10m', target: 100 }, // Stay at 100 users
    { duration: '5m', target: 0 }, // Ramp down
  ],
};

export default function() {
  // Magic-Link Flow
  const magicResponse = http.post('http://localhost:3000/auth/magic/start', {
    email: `user${__VU}@example.com`
  });
  
  check(magicResponse, {
    'magic link request status is 200': (r) => r.status === 200,
    'magic link response time < 500ms': (r) => r.timings.duration < 500,
  });
  
  // Session validation
  const sessionResponse = http.get('http://localhost:3000/auth/me', {
    headers: { Cookie: 'wg_session=test-session-id' }
  });
  
  check(sessionResponse, {
    'session validation < 100ms': (r) => r.timings.duration < 100,
  });
  
  sleep(1);
}

// tests/load/websocket-fanout.js (erweitert)
export let options = {
  vus: 200,
  duration: '30s',
};

export default function() {
  const response = ws.connect('wss://localhost:443/live', {
    headers: { Cookie: 'wg_session=test-session-id' }
  }, function(socket) {
    socket.on('message', function(message) {
      const data = JSON.parse(message);
      check(data, {
        'has tile updates': (d) => d.type === 'tile-update',
        'latency under 300ms': (d) => {
          if (d.timestamp) {
            return Date.now() - d.timestamp < 300;
          }
          return true;
        },
        'includes faden subtype': (d) => d.updates?.some(u => u.fadenSubtype)
      });
    });
  });
}
```

***

## 9) Phasen & Roadmap

### 9.1 Phase A (Lokale Weberei komplett, 0-6 Wochen)

**Lieferung:**
- ‚úÖ Karte+R√§ume auto, Login (WebAuthn + Magic-Link) mit Rollen-Drehung
- ‚úÖ Links-Drawer (Webrat+N√§hst√ºbchen), Rechts-Filter mit Fadenarten-Toggles
- ‚úÖ Oben Konto, unten Timeline (Snap+optional SSE)
- ‚úÖ Fadenarten (7 Subtypen, farbkodiert), Delegationsf√§den **immer sichtbar**
- ‚úÖ Einspruch‚áí+7d Finalabstimmung (fix, max 1 pro Rolle), Quorum-Fallback
- ‚úÖ Delegation 1:1 (Expiry 4 Wo)
- ‚úÖ Erweiterte Dexie-Offline mit Konfliktl√∂sung, A11y-Basics
- ‚úÖ Interaktive Onboarding-Tour (FF_TOUR=true)
- ‚úÖ Kosten-Metrik, NPS-Tracking, Runbooks, Chain-Crawler
- ‚úÖ AdminAction Events, Session-Management

**Gates:**
- ‚úÖ 50+ aktive Nutzer, NPS ‚â•4/5
- ‚úÖ P95 API ‚â§250ms, WS ‚â§300ms, Lag <1s
- ‚úÖ Auth: Magic-Link <2s, WebAuthn <1s
- ‚úÖ Kosten ‚â§‚Ç¨35/Monat, Cost per 1k Events <‚Ç¨0.01

### 9.2 Phase B (Resilienz & Komfort, 7-12 Wochen)
- üîÑ NATS 3-Node-Cluster + **Leafnodes konfiguriert (Dry-Run lokal)**
- üîÑ PG-HA (Stolon/PG Cluster)
- üîÑ WebPush (granular: Antr√§ge/Einspr√ºche/Delegierter-Aktionen)
- üîÑ Transitive Delegation (Zyklen-Check)
- üîÑ Optional WebGL-Layer f√ºr F√§den bei >1000 aktiven F√§den
- üîÑ Mehrfach-Rollen pro Account (accounts‚Üîrollen n:m)

**Zus√§tzliche Gates:**
- Federation-Vorbereitung: Leafnodes (7422) konfiguriert, erste Cross-Tests
- Timeline-Performance: Delta-Replay 500 Events P95 <300ms mit SSE
- Auth-Performance: Session-Validierung P95 <50ms

### 9.3 Phase C (F√∂deration, 13-20 Wochen)
- üåê Leafnodes produktiv (TLS, mutual auth)
- üåê Mirror-Streams mit ed25519-Signaturen
- üåê DNS-SRV Discovery (`_nats._tcp.weltgewebe.net`)
- üåê KeyRevoked-Events f√ºr Signatur-Invalidierung
- üåê Cross-Ort Event-Synchronisation
- üåê F√∂derierte Auth-Claims (signierte RolleVerifiziert-Attestationen)

**Gates:**
- Cross-Federation: Mirror 1k Events zwischen Orten mit Lag <1s P95  
- Failover: Ausfall eines Ortes ‚Üí andere lesen weiter (<30s)
- Security: Invalid Signature ‚Üí Reject + Alert in <1s
- Scale: 10 Ortswebereien, 1000+ aktive Rollen

***

## 10) Zukunftsmusik-Integration

### 10.1 Kollektive Recherche-Tools

```typescript
interface RechercheProjekt {
  id: string;
  titel: string;
  frage: string;
  quellen: Quelle[];
  hypothesen: Hypothese[];
  konsens: number;              // 0-1: Wie einig sind wir uns?
  qualit√§tsStufe: 'draft' | 'peer_reviewed' | 'consensus';
}

interface Quelle {
  url: string;
  title: string;
  author?: string;
  credibilityScore: number;     // Community-Bewertung
  verifiedBy: string[];         // Peer-Checks
  bias?: string;               // Einsch√§tzung der Tendenz
}

class RechercheTool {
  async synthesizeFindings(projektId: string): Promise<string> {
    const projekt = await this.getProjekt(projektId);
    
    const summary = await aiService.summarize({
      sources: projekt.quellen,
      question: projekt.frage,
      hypotheses: projekt.hypothesen,
      tone: 'neutral-wissenschaftlich'
    });
    
    await eventBus.publish({
      type: 'SyntheseVorgelegt',
      payload: { projektId, summary, generatedBy: 'ki-v1', reviewRequired: true }
    });
    
    return summary;
  }
}
```

### 10.2 Partizipartei / Live-Streaming

```typescript
interface PolitikStream {
  fadentraegerId: string;       // Gew√§hlter Vertreter
  streamUrl: string;           // WebRTC/YouTube/Twitch
  chatRoomId: string;          // Live-Chat f√ºr Input
  schedule: StreamSchedule[];   // Geplante Termine
  transparency: {
    decisions: Decision[];      // Entscheidungen live
    votes: Vote[];             // Abstimmungen im Parlament
    input: InputSummary[];     // Zusammenfassung Chat-Input
  };
}

class StreamModeration {
  async filterChatInput(messages: ChatMessage[]): Promise<FilteredInput> {
    // Up-/Down-Voting durch Weberei-Mitglieder
    const votedMessages = messages.filter(m => m.score > 5);
    
    // KI-Kategorisierung
    const categorized = await aiService.categorize(votedMessages, [
      'factual-question', 'policy-suggestion', 'criticism', 'support'
    ]);
    
    return {
      topQuestions: categorized['factual-question'].slice(0, 5),
      policySuggestions: categorized['policy-suggestion'],
      sentiment: this.analyzeSentiment(categorized),
      urgentIssues: this.detectUrgency(categorized)
    };
  }
}
```

***

## 11) Implementierungsstart

### 11.1 Priorisierte Setup-Tasks (mit Dependencies)

1. **Repository Setup** (Tag 1, keine Deps)
   - Monorepo mit pnpm workspaces erstellen
   - Packages: schemas, event-bus, ui  
   - Apps: api, web, worker-projection, worker-jobs
   - Docker Compose + Secrets Structure

2. **DB-Migrationen fahren** (Tag 2, nach 1.)
   - PostgreSQL + PostGIS Setup
   - Alle Tables, Indices, Constraints (inkl. Fadenarten + Auth)
   - Enum-Erweiterungen f√ºr antrag_status

3. **Event-Schema Implementation** (Tag 2, parallel zu 2.)
   - Zod-Schemas f√ºr alle Event-Typen mit Subtypen + Auth
   - Hash-Chain Validation Logic
   - TypeScript Codegen f√ºr Frontend

4. **EventBus + NATS Setup** (Tag 3, nach 2./3.)
   - JetStream Stream-Konfiguration (√∂ffentlich + auth subjects)
   - Auto-Fallback zu Redis
   - Basic Publish/Subscribe Test

5. **API + Auth Foundation** (Tag 4, nach 4.)
   - Fastify + Session Plugin + WebAuthn/Magic-Link
   - Validation Middleware
   - Health Checks (/live, /ready + auth checks)

6. **Worker-Jobs aktivieren** (Tag 5, nach 4./5.)
   - Einspruch‚ÜíVote, Delegations-Expiry, Knoten-Fade
   - **Session-Sweeper**, Chain-Crawler
   - Projection Worker (Events ‚Üí Read-Models)

7. **Frontend Scaffold + Auth UI** (Tag 6, nach 5.)
   - SvelteKit + MapLibre Setup
   - Login-Drawer, Rollen-Drehung Animation
   - Pull-Tab Components + Fadenarten-Filter
   - Service Worker + Erweiterte Dexie-Outbox

8. **Integration + E2E Tests** (Tag 7, nach 6.)
   - Complete flow: Login ‚Üí Create Knoten ‚Üí Spawn Faden ‚Üí See on Map
   - Automatischer Raum wird erstellt und √∂ffnet
   - Auth-Tests, Governance-Tests, Offline-Tests
   - Basic monitoring setup

9. **Karten-Knoten anlegen** (Setup-Phase, nach 8.)
   - Ortsgewebekonto, Webrat, N√§hst√ºbchen (Koordinaten & Icons festlegen)

10. **Onboarding & Polish** (Setup-Phase, nach 9.)
    - Interaktive Tour (FF_TOUR=true)
    - Legende, Farben (A11y-kontrastiert) 
    - Kosten-Event initial setzen (KostenAktualisiert{monat, betrag})

### 11.2 Go/No-Go Kriterium

**Nach 7 Tagen m√ºssen folgende Flows funktionieren:**
1. ‚úÖ Magic-Link oder WebAuthn Login ‚Üí Session erstellt
2. ‚úÖ **Rollen-Drehung** nach Login (respektiert reduced-motion)
3. ‚úÖ User kann Knoten auf Karte kn√ºpfen ‚Üí **Automatischer Raum** wird erstellt
4. ‚úÖ Tap auf Knoten √∂ffnet Raum-Fenster 
5. ‚úÖ Kommentar im Raum erzeugt **Gespr√§chsfaden** auf Karte
6. ‚úÖ **Delegationsf√§den sind immer sichtbar** (keine Opt-out)
7. ‚úÖ Faden ist 7 Tage lang sichtbar, dann Alpha-Fade
8. ‚úÖ **Einspruch-Limit** funktioniert (max 1 pro Rolle/Antrag)
9. ‚úÖ Alle Events landen in NATS JetStream (√∂ffentlich + auth getrennt)
10. ‚úÖ Bei NATS-Ausfall: Auto-Fallback zu Redis funktioniert

### 11.3 Offene Mini-Entscheidungen (beim Kickoff festzuzurren)

- **Exakte Koordinaten** f√ºr Konto/Webrat/N√§hst√ºbchen (symbolisch vs. praktisch)
- **L√§nge des Voting-Fensters** (24/48/72h) nach AbstimmungGestartet (Instanz-Policy)  
- **Standard-Quorum**: 10% verifizierte Rollen (anpassbar per Instanz)
- **FF_TOUR Standard**: true in Phase A (kann sp√§ter projektweise deaktiviert werden)
- **FF_OIDC Standard**: false (nur bei Bedarf aktivieren)

***

## 12) Schlusswort

### 12.1 Kernessenz der Weltweberei

Das Weltgewebe lebt davon, dass **jeder Faden sichtbar, √ºberpr√ºfbar und verg√§nglich ist** ‚Äì au√üer er wird gemeinschaftlich verzwirnt zu dauerhaftem Garn. **Jede aktive Aktion erzeugt automatisch einen nachvollziehbaren Fu√üabdruck**, jede Entscheidung ist transparent und kann hinterfragt werden. **Passive Betrachtung bleibt unsichtbar, Login erzeugt keinen Faden** ‚Äì Sichtbarkeit ist die einzige W√§hrung.

**Delegationsf√§den sind immer sichtbar** ‚Äì Transparenz in der Stimm√ºbertragung ist essentiell f√ºr Vertrauen. **Einspr√ºche sind begrenzt** (max 1 pro Rolle/Antrag) um Missbrauch zu verhindern. **Quorum-Fallbacks pausieren statt ablehnen** ‚Äì Antr√§ge bekommen eine zweite Chance.

Die Technik dient der Vision: Ein **sichtbarer Organismus kollektiven Handelns**, der von Nachbarschaft bis globales Myzel skaliert, ohne Token oder Credits, aber mit radikaler Transparenz, datensparsamer Authentifizierung und R√ºckrufbarkeit aller Delegierten.

### 12.2 Neuerungen in v12.2

- **Vollst√§ndiger Login-Flow**: WebAuthn Passkeys + Magic-Link Fallback mit datensparsamer Session-Verwaltung
- **Rollen-Drehung**: Subtile 540¬∞-Animation nach Login (A11y-respektierend)  
- **Erweiterte Governance**: Einspruch-Limits, automatisches Quorum mit Fallback-Logik
- **Verbesserte UX**: Interaktive Onboarding-Tour, erweiterte Suche mit Fadenarten-Filter
- **Robuste Offline-Unterst√ºtzung**: Konfliktl√∂sung mit User-Prompts
- **Community Health**: NPS-Tracking und erweiterte Observability
- **Immer sichtbare Delegationen**: Transparenz in Stimm√ºbertragungen ohne Opt-out

v12.2 vereint die bew√§hrten Kernlogiken aus v11.1 mit den umfangreichen technischen Details aus v12, erweitert um moderne Authentifizierung und optimierte User Experience ‚Äì ohne die philosophischen Grundlagen zu verw√§ssern.

**‚à¥ Die Weltweberei beginnt mit dem ersten Login und dem ersten gesponnenen Faden. Die Garnrolle dreht sich, die Weberei erwacht! üßµ**


als n√§chstes zu implementieren: 

1. √ºberlappende fadenlogik (mehrere nebeneinander von einer rolle zu einem knoten f√ºhrende f√§den liegen √ºberlappend nebeneinander. je mehr f√§den, desto mehr √ºberlappung (sonst zu breit))

2. f√ºr andere weber sichtbarer online-status (glow der rolle?)